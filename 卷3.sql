/** 五 综合题*/
CREATE DATABASE market;
USE market;
CREATE TABLE P(
    PNO CHAR(11) PRIMARY KEY,
    PNAME CHAR(40) NOT NULL,
    CITY CHAR(40) NOT NULL,
    COLOR CHAR(10) NOT NULL
);
CREATE TABLE M(
    MNO CHAR(11) PRIMARY KEY,
    MNAME CHAR(40) NOT NULL,
    CITY CHAR(40) NOT NULL
);
CREATE TABLE S(
    MNO CHAR(11),
    PNO CHAR(11),
    QTY INT,
    CONSTRAINT FK_MNO FOREIGN KEY(MNO) REFERENCES M(MNO),
    CONSTRAINT FK_PNO FOREIGN KEY(PNO) REFERENCES P(PNO),
    CONSTRAINT QTY_CK CHECK(QTY > 0)
);

DELETE P;
INSERT INTO P VALUES('000', '毛巾', '浙江', '红色');
INSERT INTO P VALUES('001', '勺子', '湖南', '红色');
INSERT INTO P VALUES('002', '键盘', '江西', '红色');
INSERT INTO P VALUES('003', '手机', '广东', '红色');
INSERT INTO P VALUES('004', '耳机', '广东', '蓝色');
SELECT * FROM P;

DELETE M;
INSERT INTO M VALUES('000', '佳惠超市', '四川');
INSERT INTO M VALUES('001', '沃尔玛超市', '北京');
INSERT INTO M VALUES('002', '京东超市', '上海');
INSERT INTO M VALUES('003', '华联超市', '上海');
SELECT * FROM M;

DELETE S;
INSERT INTO S VALUES('000', '000', 2);
INSERT INTO S VALUES('000', '001', 3);
INSERT INTO S VALUES('000', '002', 4);
INSERT INTO S VALUES('001', '003', 5);
INSERT INTO S VALUES('002', '004', 6);
INSERT INTO S VALUES('003', '004', 5);
SELECT * FROM (M LEFT JOIN S ON M.MNO=S.MNO);



SELECT MNAME, M.CITY FROM M,S 
WHERE M.MNO=S.MNO AND
S.PNO IN (SELECT P.PNO FROM P WHERE P.CITY='浙江');

SELECT S.PNO,AVG(QTY) FROM M, S 
WHERE M.MNO=S.MNO AND M.CITY='上海'
GROUP BY S.PNO;


SELECT MNO,PNO,QTY FROM S
WHERE PNO IN (SELECT PNO FROM P WHERE P.COLOR='蓝色');


SELECT M.MNO, SUM(QTY) AS RED_CT 
FROM M, S
WHERE M.MNO=S.MNO AND
S.PNO IN (
    SELECT PNO FROM P  WHERE P.COLOR='红色')
    GROUP BY M.MNO;